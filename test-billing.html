<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Razorpay Integration</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .plan {
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background-color: #2a2a2a;
        }
        .plan.pro {
            border-color: #8b5cf6;
            background-color: #3a2a5a;
        }
        button {
            background-color: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background-color: #7c3aed;
        }
        .test-results {
            margin-top: 30px;
            padding: 20px;
            background-color: #1e293b;
            border-radius: 10px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>Razorpay Integration Test</h1>
    <p>This page tests the Razorpay integration functionality without requiring authentication.</p>

    <div class="plan">
        <h3>Free Plan</h3>
        <p>₹0/month</p>
        <ul>
            <li>Basic transcription</li>
            <li>Up to 5 hours/month</li>
            <li>English only</li>
        </ul>
        <button disabled>Current Plan</button>
    </div>

    <div class="plan pro">
        <h3>Pro Plan</h3>
        <p>₹29/month</p>
        <ul>
            <li>Unlimited transcription</li>
            <li>Multi-language support</li>
            <li>Speaker identification</li>
            <li>Export options</li>
        </ul>
        <button onclick="testRazorpayPayment()">Subscribe to Pro</button>
    </div>

    <div class="test-results">
        <h3>Test Results:</h3>
        <div id="testOutput">
            <p class="info">Click "Subscribe to Pro" to test Razorpay integration...</p>
        </div>
    </div>

    <script>
        // Test configuration
        const RAZORPAY_KEY_ID = 'rzp_test_xxxxxxxxxxxxxx'; // Replace with your test key
        const TEST_API_BASE = 'http://localhost:3001/api/payments';

        function log(message, type = 'info') {
            const output = document.getElementById('testOutput');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        async function testAPIs() {
            log('Testing API endpoints...', 'info');
            
            try {
                // Test plans API
                const response = await fetch(`${TEST_API_BASE}/plans`);
                const data = await response.json();
                
                if (data.success && data.plans) {
                    log(`✓ Plans API working - Found ${data.plans.length} plans`, 'success');
                    return data.plans;
                } else {
                    log('✗ Plans API failed', 'error');
                    return null;
                }
            } catch (error) {
                log(`✗ API Error: ${error.message}`, 'error');
                return null;
            }
        }

        async function testRazorpayPayment() {
            log('Starting Razorpay payment test...', 'info');
            
            // First test APIs
            const plans = await testAPIs();
            if (!plans) {
                log('Cannot proceed - API test failed', 'error');
                return;
            }

            const proPlan = plans.find(p => p.name === 'Pro');
            if (!proPlan) {
                log('Pro plan not found', 'error');
                return;
            }

            log(`Found Pro plan: ₹${proPlan.price_monthly/100}/month`, 'success');

            // Test Razorpay checkout (this will fail without proper setup but we can test the flow)
            try {
                if (typeof Razorpay === 'undefined') {
                    log('✗ Razorpay script not loaded', 'error');
                    return;
                }

                log('✓ Razorpay script loaded', 'success');

                // Create test order (this will likely fail without authentication but we can test the flow)
                try {
                    const orderResponse = await fetch(`${TEST_API_BASE}/create-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            planId: proPlan.id,
                            billingCycle: 'monthly'
                        })
                    });

                    if (orderResponse.status === 401) {
                        log('✓ Authentication working (401 unauthorized as expected)', 'success');
                        log('✓ API endpoints are properly protected', 'success');
                        testRazorpayUI();
                        return;
                    }

                    const orderData = await orderResponse.json();
                    log(`Order creation response: ${JSON.stringify(orderData)}`, 'info');

                } catch (error) {
                    log(`Order creation test: ${error.message}`, 'info');
                    testRazorpayUI();
                }

            } catch (error) {
                log(`Razorpay test error: ${error.message}`, 'error');
            }
        }

        function testRazorpayUI() {
            log('Testing Razorpay UI integration...', 'info');
            
            // Test Razorpay options (won't actually charge)
            const options = {
                key: RAZORPAY_KEY_ID,
                amount: 2900, // ₹29 in paise
                currency: 'INR',
                name: 'Voiceflow',
                description: 'Pro Plan - Monthly billing',
                theme: {
                    color: '#8b5cf6'
                },
                modal: {
                    ondismiss: function() {
                        log('Razorpay modal dismissed', 'info');
                    }
                },
                handler: function(response) {
                    log('✓ Razorpay payment handler called', 'success');
                    log(`Payment ID: ${response.razorpay_payment_id}`, 'success');
                    log(`Order ID: ${response.razorpay_order_id}`, 'success');
                    log(`Signature: ${response.razorpay_signature}`, 'success');
                },
            };

            // Only create Razorpay instance if we have a valid key
            if (RAZORPAY_KEY_ID !== 'rzp_test_xxxxxxxxxxxxxx') {
                try {
                    const rzp = new Razorpay(options);
                    log('✓ Razorpay instance created successfully', 'success');
                    // rzp.open(); // Uncomment to actually open checkout
                    log('! Payment modal would open here (commented out for testing)', 'info');
                } catch (error) {
                    log(`✗ Razorpay instance creation failed: ${error.message}`, 'error');
                }
            } else {
                log('! Update RAZORPAY_KEY_ID in this file to test actual payment flow', 'info');
                log('✓ UI integration setup is correct', 'success');
            }
        }

        // Auto-run API tests when page loads
        window.addEventListener('load', function() {
            log('Page loaded, running initial tests...', 'info');
            testAPIs();
        });
    </script>
</body>
</html>